branches:
  only:
  - master
  - develop
  - feature/cc-codecoverage

dist: xenial
os: linux
addons:
  apt:
    packages:
      - build-essential
      - curl
      - libltdl7
      - git
      - make

services:
  - docker

language: python
python:
  - "3.7"

env:
  global:
    - TEST_NODE=http://localhost:3013
    - TEST_URL=http://localhost:3013
    - TEST_DEBUG_URL=http://localhost:3113
    - TEST_NETWORK_ID=ae_devnet
    - COMPILER_URL=http://localhost:3080
    - FORCE_COMPATIBILITY=false

cache:
  timeout: 604800 # 7 days
  directories:
    - $HOME/.cache/pip

before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log

before_install:
  - docker-compose up -d node compiler
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter

install:
  - pip install -r requirements.txt

before_script:
  - ./cc-test-reporter before-build

jobs:
  include:
    - stage: create coverage workspace
      if: type != "cron"
      workspaces:
        create:
          name: coverage
      script:
        - make lint
    - stage: Tests
      name: Test AENS, Channels
      workspaces:
        use:
          - coverage
      if: type != "cron"
      script:
        - make lint
        - make test TEST_OPTS="-k 'test_name or test_channel'"
        - cp coverage.xml coverage.1.xml
    - stage: Tests
      name: Test Compiler, Contracts, Sophia Transformation, Hashing, CLI, HDWallet, Oracle, Node, OpenAPI, Signing, Transactions, Utils
      workspaces:
        use:
          - coverage
      if: type != "cron"
      script:
        - make lint
        - make test TEST_OPTS="-k 'test_sophia or test_contract_native or test_type_conversion_to_sophia or test_oracle or test_cli or test_transaction or test_utils or test_hashing or test_hdwallet or test_node or test_generatedcli or test_signing'"
        - cp coverage.xml coverage.2.xml
    - stage: Tests
      name: Test API, Tutorials, Examples
      workspaces:
        use:
          - coverage
      if: type != "cron"
      script:
        - make lint
        - make test TEST_OPTS="-k 'test_api or test_tutorial or test_example'"
        - cp coverage.xml coverage.3.xml
        - cat coverage.3.xml
    - stage: Test with latest node and compiler
      if: type = "cron"
      env:
        - NODE_TAG=master
        - COMPILER_TAG=latest
        - FORCE_COMPATIBILITY=true
      script:
        - make lint
        - make test
    - stage: Upload test coverage
      workspaces:
        use:
          - coverage
      if: type != "cron"
      script:
        - cat coverage.1.xml
        - if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then ./cc-test-reporter sum-coverage --output - --parts 3 coverage.*.xml | ./cc-test-reporter upload-coverage --input -; fi
